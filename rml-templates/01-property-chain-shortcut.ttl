@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix rml: <http://semweb.mmlab.be/ns/rml#> .
@prefix ql: <http://semweb.mmlab.be/ns/ql#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix uni: <http://example.org/university#> .
@prefix carml: <http://carml.taxonic.com/carml/> .

# Map Student studies -> subject <- Professor teaches
#       into Student studiesUnderProfessor

_:StudentSource
    rml:source [ a carml:Stream ] ;
    rml:referenceFormulation ql:JSONPath  ;
    rml:iterator "$[?(@['http://example.org/university#major'])]"
.

_:ProfessorSource
    rml:source [ a carml:Stream ] ;
    rml:referenceFormulation ql:JSONPath  ;
    rml:iterator "$[?(@['http://example.org/university#teaches'])]"
.

_:CoursesSource
    rml:source [ a carml:Stream ] ;
    rml:referenceFormulation ql:JSONPath  ;
    rml:iterator "$[?(@['@type'] == 'http://www.w3.org/2000/01/rdf-schema#Class')]"
.


_:ProfessorsWithCourses a rr:TriplesMap ;
    rml:logicalSource _:ProfessorSource ;

    rr:subjectMap [
        rr:template "{.@id}" ;
    ] ;

    rr:predicateObjectMap [
        rr:predicate uni:teaches ;

        rr:objectMap [
            rr:parentTriplesMap [
                rml:logicalSource _:CoursesSource ;

                rr:subjectMap [
                    rr:template "{.@id}" ;
                ] ;
            ] ;

            rr:joinCondition [
                rr:parent "$['@id']" ;
                rr:child "$['http://example.org/university#teaches']" ;
            ] ;
        ] ;
    ] ;
.

_:StudentsUnderProfessors a rr:TripleMap ;
    rml:logicalSource _:StudentSource ;

    rr:subjectMap [
        rr:template "{.@id}" ;
        rr:class uni:Student ;
    ] ;

    rr:predicateObjectMap [
        rr:predicate uni:studiesUnderProfessor ;

        rr:objectMap [
            rr:parentTriplesMap _:ProfessorsWithCourses ;

            rr:joinCondition [
                rr:parent "$['http://example.org/university#teaches']" ;
                rr:child "$['http://example.org/university#major']" ;
            ] ;
        ] ;
    ] ;
.

