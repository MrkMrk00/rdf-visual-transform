@prefix rr: <http://www.w3.org/ns/r2rml#> .
@prefix rml: <http://semweb.mmlab.be/ns/rml#> .
@prefix ql: <http://semweb.mmlab.be/ns/ql#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix uni: <http://example.org/university#> .

# Map Student studies -> subject <- Professor teaches
#       into Student studiesUnderProfessor

<#StudentSource>
    rml:source "input"                    ;
    rml:referenceFormulation ql:JSONPath  ;
    rml:iterator "$[?(@['http://example.org/university#major'])]"
.

<#ProfessorSource>
    rml:source "input"                    ;
    rml:referenceFormulation ql:JSONPath  ;
    rml:iterator "$[?(@['http://example.org/university#teaches'])]"
.

<#CoursesSource>
    rml:source "input"                    ;
    rml:referenceFormulation ql:JSONPath  ;
    rml:iterator "$[?(@['@type'] == 'http://www.w3.org/2000/01/rdf-schema#Class')]"
.

<#CreatePropertyShortcutMapping> a rr:TriplesMap ;
    rml:logicalSource <#StudentSource> ;
    rr:subjectMap [
        rr:template "{@id}" ;
    ] ;

    rr:predicateObjectMap [
        rr:predicate uni:studiesUnderProfessor ;
        rr:objectMap [
            rr:parentTriplesMap [
                rml:logicalSource <#ProfessorSource> ;
                rr:subjectMap [
                    rr:template "{@id}" ;
                ] ;

                rr:predicateObjectMap [
                    rr:predicate uni:teaches ;

                    rr:objectMap [
                        rr:parentTriplesMap [
                            rml:logicalSource <#CoursesSource> ;
                            rr:subjectMap [
                                rr:template "{@id}" ;
                            ] ;
                        ] ;

                        rr:joinCondition [
                            rr:child "http://example.org/university#teaches" ;
                            rr:parent "@id" ;
                        ] ;
                    ] ;
                ] ;
                rr:joinCondition [
                    rr:child "http://example.org/university#major" ;
                    rr:parent "http://example.org/university#teaches" ;
                ] ;
            ] ;
        ] ;
    ] ;
.
